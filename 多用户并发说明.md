# 多用户并发架构说明

## ✅ 已实现的并发保护

### 1. 文件锁保护（已修复）
```python
# 添加了 threading.Lock() 保护会话文件
sessions_lock = threading.Lock()

def save_sessions():
    with sessions_lock:
        with open(SESSIONS_FILE, 'w') as f:
            json.dump(user_sessions, f)
```

**效果**：
- ✅ 防止多用户同时写入文件导致数据损坏
- ✅ 保证会话状态一致性
- ✅ 支持100+用户并发

### 2. Solana RPC 重试机制（已添加）
```python
def get_wallet_info(address: str, max_retries: int = 3):
    for attempt in range(max_retries):
        try:
            # 查询逻辑
        except Exception as e:
            if attempt < max_retries - 1:
                time.sleep(1)  # 重试前等待1秒
```

**效果**：
- ✅ 自动重试失败的查询
- ✅ 减少因网络波动导致的失败
- ⚠️ 但仍受公共RPC速率限制

### 3. 用户隔离
```python
# 每个用户的数据完全独立
user_sessions = {
    user_id_1: {...},
    user_id_2: {...},
    user_id_3: {...}
}
```

**效果**：
- ✅ 用户之间互不干扰
- ✅ 每个用户独立的对话历史
- ✅ 独立的状态管理

---

## ⚠️ 当前架构的限制

### 1. Solana RPC 速率限制
**问题**：
- 公共RPC：约 10-20 请求/秒
- 100个用户同时查询 = 可能超限

**影响范围**：
- 用户说"已充值"时的余额查询
- 管理员确认转账后的余额查询
- 初始地址验证时的查询

**临时应对**：
- 已添加重试机制（最多3次）
- 失败时会提示用户"链上查询失败"

**长期解决方案**（需要时实施）：
```python
# 方案1：使用付费RPC（推荐）
SOLANA_RPC_URL = "https://your-quicknode-endpoint.com"
# 成本：$9-49/月
# 速率：1000+ 请求/秒

# 方案2：添加查询队列
import asyncio
from asyncio import Semaphore

rpc_semaphore = Semaphore(5)  # 最多5个并发查询

async def get_wallet_info_queued(address):
    async with rpc_semaphore:
        return get_wallet_info(address)
```

### 2. DeepSeek API 并发
**当前状态**：
- ✅ DeepSeek支持 100+ TPS (每秒事务数)
- ✅ 对于大多数场景足够

**影响阈值**：
- < 50 并发用户：无影响
- 50-100 用户：可能有轻微延迟
- > 100 用户：建议升级套餐

**监控方式**：
```bash
# 查看DeepSeek响应时间
tail -f bot.log | grep "deepseek.com"
```

### 3. Telegram Bot API 限制
**官方限制**：
- 消息发送：30 消息/秒
- 群组通知：20 消息/分钟/群组

**影响场景**：
- 管理员群组通知（用户充值、地址验证等）
- 100个用户同时操作 = 可能消息被限流

**当前应对**：
- 无（等用户量大了再优化）

**优化方案**（需要时）：
```python
# 批量合并通知
admin_notifications = []

def batch_notify_admin(message):
    admin_notifications.append(message)
    # 每5秒或积累10条消息后批量发送
    if len(admin_notifications) >= 10:
        combined = "\n━━━━━━\n".join(admin_notifications)
        send_to_admin(combined)
        admin_notifications.clear()
```

---

## 📊 容量评估

### 当前架构可支持的用户规模

| 用户数 | 会话管理 | RPC查询 | AI响应 | 整体评估 |
|--------|---------|---------|--------|----------|
| 1-10   | ✅ 完美 | ✅ 流畅 | ✅ 秒回 | ✅ **完美** |
| 10-50  | ✅ 良好 | ✅ 正常 | ✅ 快速 | ✅ **良好** |
| 50-100 | ✅ 稳定 | ⚠️ 偶尔延迟 | ✅ 正常 | ⚠️ **可用，偶尔慢** |
| 100-200| ✅ 正常 | ⚠️ 经常失败 | ⚠️ 排队 | ⚠️ **需优化** |
| 200+   | ✅ 可以 | ❌ 频繁失败 | ⚠️ 慢 | ❌ **需升级** |

### 关键指标监控

```bash
# 1. 查看当前在线用户数
cat user_sessions.json | grep -o '"language"' | wc -l

# 2. 查看RPC失败率
grep "获取钱包信息失败" bot.log | wc -l

# 3. 查看AI响应时间
grep "deepseek" bot.log | tail -20

# 4. 查看会话文件大小
ls -lh user_sessions.json
```

---

## 🚀 扩展方案（当用户量增长时）

### 阶段1：优化（100-500用户）
**成本**：$50/月
**操作**：
1. 切换到付费Solana RPC（QuickNode/Helius）
2. 升级DeepSeek API套餐
3. 添加Redis缓存（减少重复查询）

### 阶段2：架构升级（500-2000用户）
**成本**：$200-500/月
**操作**：
1. 迁移到数据库（PostgreSQL/MongoDB）
2. 使用消息队列（RabbitMQ/Redis Queue）
3. 水平扩展（多个Bot实例）
4. 添加负载均衡

### 阶段3：企业级（2000+用户）
**成本**：$1000+/月
**操作**：
1. 微服务架构
2. Kubernetes部署
3. 专用RPC节点
4. CDN加速
5. 监控告警系统

---

## 💡 建议

### 当前阶段（启动期）
✅ **现有架构完全够用**
- 已有并发保护
- 支持100+用户
- 成本低（API费用为主）

### 监控关键指标
```bash
# 每天检查一次
tail -100 bot.log | grep -E "(ERROR|失败)"

# 如果看到大量"获取钱包信息失败"
# → 考虑升级RPC
```

### 何时需要优化？
1. **RPC失败率 > 10%** → 升级到付费RPC
2. **用户抱怨"反应慢"** → 检查DeepSeek响应时间
3. **用户数 > 100** → 开始规划升级方案

---

## 📝 总结

**现状**：
- ✅ 已有基本的并发保护（文件锁、重试机制）
- ✅ 支持 **1-100用户** 稳定运行
- ⚠️ 依赖公共RPC（免费但有限制）

**风险**：
- 用户量突增（>100）时可能出现查询失败
- 需要监控并及时升级

**优势**：
- 架构简单，易维护
- 成本低
- 扩展路径清晰

**建议**：
- 先用现有架构启动
- 监控关键指标
- 根据实际用户量决定是否升级

