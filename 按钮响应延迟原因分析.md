# ğŸŒ æŒ‰é’®ç‚¹å‡»å“åº”å»¶è¿Ÿåˆ†æ

## ğŸ” é—®é¢˜å®šä½

### å½“å‰ä»£ç æµç¨‹ï¼ˆç¬¬577-621è¡Œï¼‰

```python
async def language_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()  # âœ… ç¬¬580è¡Œï¼šç«‹å³å“åº”ï¼ˆ0.1ç§’ï¼‰
    
    # ä½†æ˜¯...åé¢åšäº†å¤ªå¤šåŒæ­¥æ“ä½œï¼
    
    # âŒ ç¬¬607è¡Œï¼šè°ƒç”¨AIï¼ˆ3-10ç§’é˜»å¡ï¼‰
    ai_greeting = get_ai_response(initial_message, [], lang)
    
    # âŒ ç¬¬594è¡Œï¼šè·å–å¤´åƒURLï¼ˆ1-2ç§’é˜»å¡ï¼‰
    user_sessions[user_id]['avatar_url'] = await get_user_avatar_url(...)
    
    # âœ… ç¬¬621è¡Œï¼šæœ€åæ‰æ›´æ–°æ¶ˆæ¯
    await query.edit_message_text(text=full_message)
```

---

## ğŸ’¥ æ ¸å¿ƒé—®é¢˜

### é—®é¢˜1ï¼šAIè°ƒç”¨åœ¨`query.answer()`ä¹‹å‰

```python
await query.answer()  # å·²ç»å“åº”äº†æŒ‰é’®
# ä½†æ˜¯ç”¨æˆ·çœ‹åˆ°çš„æ˜¯"åŠ è½½ä¸­"3-10ç§’
ai_greeting = get_ai_response(...)  # é˜»å¡3-10ç§’ï¼
await query.edit_message_text(...)  # 10ç§’åæ‰çœ‹åˆ°ç»“æœ
```

**ç”¨æˆ·ä½“éªŒ**:
- ç‚¹å‡»æŒ‰é’®åï¼ŒæŒ‰é’®çŠ¶æ€ç«‹å³å˜ä¸º"å·²ç‚¹å‡»" âœ…
- ä½†æ˜¯ç•Œé¢è¿˜æ˜¯æ˜¾ç¤ºæ—§å†…å®¹ï¼Œæ²¡æœ‰ä»»ä½•åé¦ˆ âŒ
- ç­‰å¾…3-10ç§’åæ‰çœ‹åˆ°AIå›å¤ âŒ

### é—®é¢˜2ï¼šåŒæ­¥å‡½æ•°é˜»å¡å¼‚æ­¥æµç¨‹

```python
def get_ai_response(...):  # è¿™æ˜¯ä¸€ä¸ªåŒæ­¥å‡½æ•°ï¼
    response = client.chat.completions.create(...)  # é˜»å¡3-10ç§’
    return response.choices[0].message.content
```

**é—®é¢˜**:
- åŒæ­¥å‡½æ•°é˜»å¡æ•´ä¸ªå¼‚æ­¥äº‹ä»¶å¾ªç¯
- å…¶ä»–ç”¨æˆ·çš„æ¶ˆæ¯ä¹Ÿæ— æ³•å¤„ç†
- é«˜å¹¶å‘æƒ…å†µä¸‹ä¼šé›ªå´©

---

## ğŸš€ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šå…ˆåé¦ˆï¼Œåå¤„ç†ï¼ˆæœ€ç®€å•ï¼‰

```python
async def language_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()  # âœ… ç«‹å³å“åº”æŒ‰é’®
    
    # âœ… ç«‹å³æ›´æ–°æ¶ˆæ¯ï¼ˆæ˜¾ç¤º"åŠ è½½ä¸­"ï¼‰
    await query.edit_message_text(
        "â³ æ­£åœ¨åŠ è½½... / Loading..."
    )
    
    # âœ… åœ¨åå°å¼‚æ­¥å¤„ç†
    ai_greeting = await asyncio.to_thread(
        get_ai_response,  # åœ¨åå°çº¿ç¨‹æ‰§è¡Œ
        initial_message, [], lang
    )
    
    # âœ… å¤„ç†å®Œæˆåæ›´æ–°æ¶ˆæ¯
    full_message = "âœ… è¯­è¨€å·²è®¾ç½®ä¸ºä¸­æ–‡\n\n" + ai_greeting
    await query.edit_message_text(text=full_message)
```

**æ•ˆæœ**: ç”¨æˆ·ç‚¹å‡»åç«‹å³çœ‹åˆ°åé¦ˆï¼ˆ0.1ç§’ï¼‰

---

### æ–¹æ¡ˆ2ï¼šæµå¼å“åº”ï¼ˆæœ€ä½³ä½“éªŒï¼‰

```python
async def language_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    # ç«‹å³æ˜¾ç¤ºç¡®è®¤
    await query.edit_message_text("âœ… æ­£åœ¨å‡†å¤‡...")
    
    # åå°è°ƒç”¨AI
    task = asyncio.create_task(
        asyncio.to_thread(get_ai_response, initial_message, [], lang)
    )
    
    # ç­‰å¾…AIå“åº”ï¼ˆä½†å¯ä»¥æ˜¾ç¤ºè¿›åº¦ï¼‰
    import asyncio
    for i in range(10):
        await asyncio.sleep(0.3)  # æ¯0.3ç§’æ£€æŸ¥ä¸€æ¬¡
        if task.done():
            break
        # æ˜¾ç¤ºè¿›åº¦
        await query.edit_message_text(
            f"â³ æ­£åœ¨ç”Ÿæˆå›å¤... ({i+1}/10)"
        )
    
    # è·å–ç»“æœ
    ai_greeting = await task
    
    # æ›´æ–°æœ€ç»ˆæ¶ˆæ¯
    full_message = "âœ… è¯­è¨€å·²è®¾ç½®\n\n" + ai_greeting
    await query.edit_message_text(text=full_message)
```

**æ•ˆæœ**: 
- 0.1ç§’çœ‹åˆ°åé¦ˆ
- å®æ—¶æ˜¾ç¤ºè¿›åº¦
- ç”¨æˆ·ä½“éªŒæœ€ä½³

---

### æ–¹æ¡ˆ3ï¼šä½¿ç”¨é¢„è®¾å›å¤ï¼ˆæœ€å¿«ï¼‰

```python
async def language_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    # âœ… ç«‹å³æ˜¾ç¤ºé¢„è®¾æ¬¢è¿è¯­ï¼ˆ0.1ç§’ï¼‰
    lang = query.data.split('_')[1]
    welcome_msg = {
        'zh': 'æ‚¨å¥½ï¼æˆ‘æ˜¯é‡åŒ–å¥—åˆ©åŠ©æ‰‹ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ã€‚',
        'en': 'Hello! I\'m your quantitative arbitrage assistant.'
    }[lang]
    
    await query.edit_message_text(
        f"âœ… è¯­è¨€å·²è®¾ç½®ä¸º{lang}\n\n{welcome_msg}"
    )
    
    # å¯é€‰ï¼šåå°å¼‚æ­¥è·å–AIå›å¤ï¼ˆä¸é˜»å¡ï¼‰
    asyncio.create_task(
        async_get_ai_response_and_update(user_id, lang, context)
    )
```

**æ•ˆæœ**: 0.1ç§’ç«‹å³å“åº”

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

| æ–¹æ¡ˆ | å“åº”æ—¶é—´ | ç”¨æˆ·ä½“éªŒ | å®ç°éš¾åº¦ |
|------|---------|---------|---------|
| å½“å‰ | 5-10ç§’ âŒ | å·® | - |
| æ–¹æ¡ˆ1 | 0.1ç§’ âœ… | å¥½ | ä½ |
| æ–¹æ¡ˆ2 | 0.1ç§’ + è¿›åº¦æ¡ âœ… | ä¼˜ç§€ | ä¸­ |
| æ–¹æ¡ˆ3 | 0.1ç§’ âœ… | å¥½ | ä½ |

---

## ğŸ¯ ç«‹å³å®æ–½å»ºè®®

### å¿«é€Ÿä¿®å¤ï¼ˆ5åˆ†é’Ÿï¼‰

```python
async def language_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()  # âœ… ç«‹å³å“åº”
    
    user_id = query.from_user.id
    lang = query.data.split('_')[1]
    
    # âœ… ç«‹å³æ˜¾ç¤ºç¡®è®¤ï¼ˆ0.1ç§’ï¼‰
    await query.edit_message_text("â³ æ­£åœ¨å‡†å¤‡...")
    
    # âœ… åå°å¼‚æ­¥è°ƒç”¨AI
    ai_greeting = await asyncio.to_thread(
        get_ai_response, 
        "ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹" if lang == 'zh' else "Hello, please introduce",
        [],
        lang
    )
    
    # âœ… æ›´æ–°æœ€ç»ˆæ¶ˆæ¯
    full_message = ("âœ… è¯­è¨€å·²è®¾ç½®ä¸ºä¸­æ–‡\n\n" + ai_greeting) if lang == 'zh' else ("âœ… Language set to English\n\n" + ai_greeting)
    await query.edit_message_text(text=full_message)
```

**åªæ”¹2å¤„ä»£ç **:
1. åœ¨ç¬¬607è¡Œå‰åŠ ï¼š`await query.edit_message_text("â³ æ­£åœ¨å‡†å¤‡...")`
2. ç¬¬607è¡Œæ”¹ä¸ºï¼š`ai_greeting = await asyncio.to_thread(get_ai_response, ...)`

æ˜¯å¦ç«‹å³å®æ–½ä¿®å¤ï¼Ÿ
