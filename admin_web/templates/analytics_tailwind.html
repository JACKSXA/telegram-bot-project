{% extends "base_tailwind.html" %}

{% block title %}æ•°æ®åˆ†æ - Botç®¡ç†åå°{% endblock %}

{% block content %}
<div class="mx-auto max-w-screen-2xl">
    <!-- Page Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">æ•°æ®åˆ†æ</h1>
        <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">ç”¨æˆ·è½¬åŒ–æ¼æ–—å’Œè¯¦ç»†ç»Ÿè®¡</p>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4 mb-6">
        <!-- Total Users -->
        <div class="stat-card rounded-[10px] bg-white px-6 py-5 shadow-md dark:bg-gray-800">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">æ€»ç”¨æˆ·æ•°</p>
                    <h3 class="mt-2 text-3xl font-bold text-gray-900 dark:text-white">{{ data.total_users }}</h3>
                </div>
                <div class="flex h-14 w-14 items-center justify-center rounded-full bg-gradient-to-br from-blue-500 to-blue-600 shadow-lg shadow-blue-500/30">
                    <i class="fas fa-users text-2xl text-white"></i>
                </div>
            </div>
        </div>

        <!-- Wallet Conversion -->
        <div class="stat-card rounded-[10px] bg-white px-6 py-5 shadow-md dark:bg-gray-800">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">é’±åŒ…è½¬åŒ–ç‡</p>
                    <h3 class="mt-2 text-3xl font-bold text-gray-900 dark:text-white">{{ "%.1f"|format(data.conversion_rates.to_wallet) }}%</h3>
                </div>
                <div class="flex h-14 w-14 items-center justify-center rounded-full bg-gradient-to-br from-green-500 to-green-600 shadow-lg shadow-green-500/30">
                    <i class="fas fa-wallet text-2xl text-white"></i>
                </div>
            </div>
        </div>

        <!-- Service Conversion -->
        <div class="stat-card rounded-[10px] bg-white px-6 py-5 shadow-md dark:bg-gray-800">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">å®¢æœè½¬åŒ–ç‡</p>
                    <h3 class="mt-2 text-3xl font-bold text-gray-900 dark:text-white">{{ "%.1f"|format(data.conversion_rates.to_service) }}%</h3>
                </div>
                <div class="flex h-14 w-14 items-center justify-center rounded-full bg-gradient-to-br from-yellow-500 to-yellow-600 shadow-lg shadow-yellow-500/30">
                    <i class="fas fa-headset text-2xl text-white"></i>
                </div>
            </div>
        </div>

        <!-- Transfer Conversion -->
        <div class="stat-card rounded-[10px] bg-white px-6 py-5 shadow-md dark:bg-gray-800">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">è½¬è´¦è½¬åŒ–ç‡</p>
                    <h3 class="mt-2 text-3xl font-bold text-gray-900 dark:text-white">{{ "%.1f"|format(data.conversion_rates.to_transfer) }}%</h3>
                </div>
                <div class="flex h-14 w-14 items-center justify-center rounded-full bg-gradient-to-br from-purple-500 to-purple-600 shadow-lg shadow-purple-500/30">
                    <i class="fas fa-exchange-alt text-2xl text-white"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 gap-6 lg:grid-cols-2 mb-6">
        <!-- Funnel Chart -->
        <div class="rounded-[10px] bg-white shadow-md dark:bg-gray-800">
            <div class="border-b border-gray-200 px-6 py-4 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-funnel-dollar mr-2"></i> è½¬åŒ–æ¼æ–—
                </h3>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    {# ä½¿ç”¨æ•°æ®åº“ç›´é‡‡å¿«ç…§ï¼Œç¡®ä¿æ•°æ®åŒæ­¥ #}
                    {% set wallet_bound_count = data.get('wallet_bound', 0) %}
                    {% set waiting_cs_count = data.get('waiting_cs', 0) %}
                    {% set bound_ready_count = data.get('bound_ready', 0) %}
                    {% set transfer_done_count = data.get('transfer_completed', 0) %}
                    
                    {% set steps = [
                        ('æ³¨å†Œç”¨æˆ·', data.total_users, 'blue'),
                        ('å·²ç»‘å®šé’±åŒ…', wallet_bound_count, 'green'),
                        ('ç­‰å¾…å®¢æœ', waiting_cs_count, 'yellow'),
                        ('è½¬è´¦å®Œæˆ', transfer_done_count, 'pink')
                    ] %}
                    
                    {% for step in steps %}
                        <div class="relative">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">{{ step[0] }}</span>
                                <span class="text-sm font-bold text-gray-900 dark:text-white">{{ step[1] }}</span>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                                {% if step[2] == 'blue' %}
                                    <div class="bg-blue-500 h-3 rounded-full transition-all duration-500" 
                                         style="width: {{ (step[1] / data.total_users * 100) if data.total_users > 0 else 0 }}%"></div>
                                {% elif step[2] == 'green' %}
                                    <div class="bg-green-500 h-3 rounded-full transition-all duration-500" 
                                         style="width: {{ (step[1] / data.total_users * 100) if data.total_users > 0 else 0 }}%"></div>
                                {% elif step[2] == 'yellow' %}
                                    <div class="bg-yellow-500 h-3 rounded-full transition-all duration-500" 
                                         style="width: {{ (step[1] / data.total_users * 100) if data.total_users > 0 else 0 }}%"></div>
                                {% elif step[2] == 'pink' %}
                                    <div class="bg-pink-500 h-3 rounded-full transition-all duration-500" 
                                         style="width: {{ (step[1] / data.total_users * 100) if data.total_users > 0 else 0 }}%"></div>
                                {% else %}
                                    <div class="bg-gray-500 h-3 rounded-full transition-all duration-500" 
                                         style="width: {{ (step[1] / data.total_users * 100) if data.total_users > 0 else 0 }}%"></div>
                                {% endif %}
                            </div>
                            {% if not loop.last %}
                                <div class="flex justify-center my-2">
                                    {% if step[2] == 'blue' %}
                                        <i class="fas fa-arrow-down text-blue-500"></i>
                                    {% elif step[2] == 'green' %}
                                        <i class="fas fa-arrow-down text-green-500"></i>
                                    {% elif step[2] == 'yellow' %}
                                        <i class="fas fa-arrow-down text-yellow-500"></i>
                                    {% elif step[2] == 'pink' %}
                                        <i class="fas fa-arrow-down text-pink-500"></i>
                                    {% else %}
                                        <i class="fas fa-arrow-down text-gray-500"></i>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- State Distribution -->
        <div class="rounded-[10px] bg-white shadow-md dark:bg-gray-800">
            <div class="border-b border-gray-200 px-6 py-4 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-chart-pie mr-2"></i> ç”¨æˆ·çŠ¶æ€åˆ†å¸ƒ
                </h3>
            </div>
            <div class="p-6">
                <div class="space-y-3">
                    {% for state, count in data.state_distribution.items() %}
                    <a href="/users?state={{ state }}" class="flex items-center justify-between p-3 rounded-lg bg-gray-50 dark:bg-gray-700/50 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition-colors">
                        <div class="flex items-center gap-3">
                            {% if state == 'waiting_customer_service' %}
                                <i class="fas fa-clock text-yellow-600 dark:text-yellow-400"></i>
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">ç­‰å¾…å®¢æœ</span>
                            {% elif state == 'bound_and_ready' %}
                                <i class="fas fa-check-circle text-green-600 dark:text-green-400"></i>
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">å·²ç»‘å®š</span>
                            {% elif state == 'wallet_verified' %}
                                <i class="fas fa-wallet text-blue-600 dark:text-blue-400"></i>
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">å·²éªŒè¯</span>
                            {% elif state == 'waiting_transfer' %}
                                <i class="fas fa-clock text-orange-600 dark:text-orange-400"></i>
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">ç­‰å¾…è½¬è´¦</span>
                            {% elif state == 'completed' %}
                                <i class="fas fa-check-double text-green-600 dark:text-green-400"></i>
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">å·²å®Œæˆ</span>
                            {% else %}
                                <i class="fas fa-user text-gray-600 dark:text-gray-400"></i>
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">{{ state }}</span>
                            {% endif %}
                        </div>
                        <span class="inline-flex items-center justify-center px-3 py-1 rounded-full text-sm font-bold bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                            {{ count }}
                        </span>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Language Distribution -->
    <div class="rounded-[10px] bg-white shadow-md dark:bg-gray-800">
        <div class="border-b border-gray-200 px-6 py-4 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                <i class="fas fa-globe mr-2"></i> è¯­è¨€åˆ†å¸ƒ
            </h3>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for lang, count in data.language_distribution.items() %}
                <div class="flex items-center justify-between p-4 rounded-lg bg-gray-50 dark:bg-gray-700/50">
                    <div class="flex items-center gap-3">
                        {% if lang == 'zh' %}
                            <i class="fas fa-flag text-blue-600 dark:text-blue-400"></i>
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">ä¸­æ–‡</span>
                        {% elif lang == 'en' %}
                            <i class="fas fa-flag text-green-600 dark:text-green-400"></i>
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">English</span>
                        {% else %}
                            <i class="fas fa-language text-gray-600 dark:text-gray-400"></i>
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">{{ lang }}</span>
                        {% endif %}
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-24 bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                            <div class="bg-{{ 'blue' if lang == 'zh' else 'green' }}-500 h-2 rounded-full" 
                                 style="width: {{ (count / data.total_users * 100) if data.total_users > 0 else 0 }}%"></div>
                        </div>
                        <span class="text-sm font-bold text-gray-900 dark:text-white w-12 text-right">{{ count }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Channel Analysis -->
    <div class="rounded-[10px] bg-white shadow-md dark:bg-gray-800 mb-6">
        <div class="border-b border-gray-200 px-6 py-4 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                <i class="fas fa-chart-pie mr-2"></i> æŒ‰æ¸ é“ç»Ÿè®¡
            </h3>
        </div>
        <div class="p-6">
            <div id="channelContainer">
                <div class="flex items-center justify-center py-8">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin text-3xl text-gray-400 mb-3"></i>
                        <p class="text-sm text-gray-500 dark:text-gray-400">åŠ è½½æ¸ é“æ•°æ®ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// åŠ è½½æ¸ é“ç»Ÿè®¡
async function loadChannelData() {
    try {
        const response = await fetch('/api/funnel-by-channel');
        const data = await response.json();
        
        if (data.success && data.channels && data.channels.length > 0) {
            const container = document.getElementById('channelContainer');
            let html = '<div class="space-y-4">';
            
            data.channels.forEach(channel => {
                const total = channel.total || 0;
                const walletRate = total > 0 ? ((channel.wallet_bound || 0) / total * 100).toFixed(1) : 0;
                const boundRate = total > 0 ? ((channel.bound_ready || 0) / total * 100).toFixed(1) : 0;
                const transferRate = total > 0 ? ((channel.transfer_completed || 0) / total * 100).toFixed(1) : 0;
                
                html += `
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <span class="text-lg font-bold text-gray-900 dark:text-white">${channel.channel || 'æœªçŸ¥æ¸ é“'}</span>
                                <span class="text-sm text-gray-500 dark:text-gray-400">(${total} ç”¨æˆ·)</span>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600 dark:text-gray-400">ğŸ’° é’±åŒ…ç»‘å®š</span>
                                <div class="flex items-center gap-2">
                                    <div class="w-32 bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                        <div class="bg-green-500 h-2 rounded-full" style="width: ${walletRate}%"></div>
                                    </div>
                                    <span class="text-sm font-bold text-gray-900 dark:text-white w-12 text-right">${walletRate}%</span>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600 dark:text-gray-400">ğŸ¤ å®¢æœç»‘å®š</span>
                                <div class="flex items-center gap-2">
                                    <div class="w-32 bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                        <div class="bg-yellow-500 h-2 rounded-full" style="width: ${boundRate}%"></div>
                                    </div>
                                    <span class="text-sm font-bold text-gray-900 dark:text-white w-12 text-right">${boundRate}%</span>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-gray-600 dark:text-gray-400">âœ… è½¬è´¦å®Œæˆ</span>
                                <div class="flex items-center gap-2">
                                    <div class="w-32 bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                        <div class="bg-purple-500 h-2 rounded-full" style="width: ${transferRate}%"></div>
                                    </div>
                                    <span class="text-sm font-bold text-gray-900 dark:text-white w-12 text-right">${transferRate}%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        } else {
            document.getElementById('channelContainer').innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-8">æš‚æ— æ¸ é“æ•°æ®</p>';
        }
    } catch (error) {
        document.getElementById('channelContainer').innerHTML = '<p class="text-center text-red-500 py-8">åŠ è½½æ¸ é“æ•°æ®å¤±è´¥</p>';
    }
}

// é¡µé¢åŠ è½½æ—¶è·å–æ¸ é“æ•°æ®
loadChannelData();
</script>
{% endblock %}

