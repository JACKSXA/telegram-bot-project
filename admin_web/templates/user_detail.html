{% extends "base.html" %}

{% block title %}ç”¨æˆ·è¯¦æƒ… - Botç®¡ç†åå°{% endblock %}

{% block content %}
<h2 class="mb-4">ç”¨æˆ·è¯¦æƒ… #{{ user_id }}</h2>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</div>
            <div class="card-body">
                <p><strong>ç”¨æˆ·ID:</strong> {{ user_id }}</p>
                <p><strong>è¯­è¨€:</strong> {{ user_data.get('language', 'N/A') }}</p>
                <p><strong>çŠ¶æ€:</strong> <span class="badge bg-info">{{ user_data.get('state', 'unknown') }}</span></p>
                <p><strong>è½¬è´¦å®Œæˆ:</strong> 
                    {% if user_data.get('transfer_completed') %}
                    <span class="badge bg-success">æ˜¯</span>
                    {% else %}
                    <span class="badge bg-secondary">å¦</span>
                    {% endif %}
                </p>
                
                <hr>
                <div class="mb-2">
                    <label class="form-label"><strong>ğŸ“ å¤‡æ³¨</strong></label>
                    <textarea id="noteInput" class="form-control" rows="3" placeholder="è¾“å…¥å¤‡æ³¨ä¿¡æ¯...">{{ user_data.get('note', '') }}</textarea>
                </div>
                <div class="mb-2">
                    <label class="form-label"><strong>ğŸ’¼ é’±åŒ…åœ°å€</strong></label>
                    <input type="text" id="walletInput" class="form-control" value="{{ user_data.get('wallet', '') }}" placeholder="é’±åŒ…åœ°å€">
                </div>
                <button onclick="saveUser()" class="btn btn-primary">
                    <i class="bi bi-save"></i> ä¿å­˜ä¿®æ”¹
                </button>
            </div>
        </div>
        
        <div class="card mb-3">
            <div class="card-header">ğŸ’¼ é’±åŒ…ä¿¡æ¯</div>
            <div class="card-body">
                <p><strong>é’±åŒ…åœ°å€:</strong></p>
                <code>{{ user_data.get('wallet', 'N/A') }}</code>
                
                {% if user_data.get('wallet_info') %}
                <hr>
                <p><strong>é’±åŒ…çŠ¶æ€:</strong></p>
                <p>ä½™é¢: {{ "%.4f"|format(user_data.wallet_info.get('balance', 0)) }} SOL</p>
                <p>è´¦æˆ·çŠ¶æ€: {{ user_data.wallet_info.get('status', 'N/A') }}</p>
                <p>æ´»è·ƒ: {% if user_data.wallet_info.get('is_active') %}âœ… æ˜¯{% else %}âŒ å¦{% endif %}</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header">ğŸ’¬ å¯¹è¯å†å²</div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                {% if user_data.get('history') %}
                    {% for msg in user_data.history %}
                    <div class="mb-2">
                        <strong>{% if msg.role == 'user' %}ğŸ‘¤ ç”¨æˆ·:{% else %}ğŸ¤– Bot:{% endif %}</strong>
                        <div class="alert alert-light">
                            {{ msg.content[:200] }}{% if msg.content|length > 200 %}...{% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <p class="text-muted">æš‚æ— å¯¹è¯å†å²</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="mt-3">
    <button onclick="sendMessage()" class="btn btn-success">
        <i class="bi bi-send"></i> å‘é€æ¶ˆæ¯
    </button>
    <a href="/users" class="btn btn-secondary">è¿”å›åˆ—è¡¨</a>
</div>

<script>
function sendMessage() {
    const message = prompt('è¾“å…¥è¦å‘é€ç»™ç”¨æˆ·çš„æ¶ˆæ¯:');
    if (message) {
        // è·³è½¬åˆ°æ¨é€é¡µé¢ï¼Œå¹¶é¢„å¡«å……ç”¨æˆ·ID
        window.location.href = `/push?target_type=selected&target_users={{ user_id }}&message=${encodeURIComponent(message)}`;
    }
}

function saveUser() {
    const note = document.getElementById('noteInput').value;
    const wallet = document.getElementById('walletInput').value;
    
    fetch('/user/{{ user_id }}/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            note: note,
            wallet: wallet
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('âœ… ä¿å­˜æˆåŠŸï¼');
            location.reload();
        } else {
            alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + data.error);
        }
    })
    .catch(error => {
        alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + error);
    });
}
</script>
{% endblock %}

