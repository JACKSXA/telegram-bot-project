{% extends "base_tailwind.html" %}

{% block title %}用户详情 - Bot管理后台{% endblock %}

{% block content %}
<div class="mx-auto max-w-screen-2xl">
    <!-- Page Header -->
    <div class="mb-6 flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">用户详情 #{{ user_id }}</h1>
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">查看和管理用户信息</p>
        </div>
        <a href="/users" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600">
            <i class="fas fa-arrow-left mr-2"></i> 返回列表
        </a>
    </div>

    <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
        <!-- Left Column -->
        <div class="space-y-6">
            <!-- Basic Info -->
            <div class="rounded-[10px] bg-white shadow-md dark:bg-gray-800">
                <div class="border-b border-gray-200 px-6 py-4 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                        <i class="fas fa-user mr-2"></i> 基本信息
                    </h3>
                </div>
                <div class="p-6 space-y-4">
                    <div class="flex items-center justify-between py-3 border-b border-gray-100 dark:border-gray-700 last:border-0">
                        <span class="text-sm font-medium text-gray-600 dark:text-gray-400">用户ID</span>
                        <span class="text-base font-mono text-gray-900 dark:text-white">{{ user_id }}</span>
                    </div>
                    <div class="flex items-center justify-between py-3 border-b border-gray-100 dark:border-gray-700 last:border-0">
                        <span class="text-sm font-medium text-gray-600 dark:text-gray-400">语言</span>
                        <span class="inline-flex items-center rounded-full px-3 py-1.5 text-sm font-medium {{ 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' if user_data.get('language') == 'zh' else 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' }}">
                            {% if user_data.get('language') == 'zh' %}中文{% else %}English{% endif %}
                        </span>
                    </div>
                    <div class="flex items-center justify-between py-3 border-b border-gray-100 dark:border-gray-700 last:border-0">
                        <span class="text-sm font-medium text-gray-600 dark:text-gray-400">状态</span>
                        <span class="inline-flex items-center rounded-full px-3 py-1.5 text-sm font-medium 
                            {% if user_data.get('state') == 'completed' %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200
                            {% elif user_data.get('state') == 'waiting_transfer' %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200
                            {% elif user_data.get('state') == 'wallet_verified' %}bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200
                            {% else %}bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300{% endif %}">
                            {% if user_data.get('state') == 'completed' %}已完成
                            {% elif user_data.get('state') == 'waiting_transfer' %}等待转账
                            {% elif user_data.get('state') == 'wallet_verified' %}已验证
                            {% elif user_data.get('state') == 'waiting_wallet' %}等待钱包
                            {% else %}空闲{% endif %}
                        </span>
                    </div>
                    <div class="flex items-center justify-between py-3">
                        <span class="text-sm font-medium text-gray-600 dark:text-gray-400">转账完成</span>
                        <span class="inline-flex items-center rounded-full px-3 py-1.5 text-sm font-medium {{ 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' if user_data.get('transfer_completed') else 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300' }}">
                            {% if user_data.get('transfer_completed') %}是{% else %}否{% endif %}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Wallet Info -->
            <div class="rounded-[10px] bg-white shadow-md dark:bg-gray-800">
                <div class="border-b border-gray-200 px-6 py-4 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                        <i class="fas fa-wallet mr-2"></i> 钱包信息
                    </h3>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">钱包地址</label>
                        {% if user_data.get('wallet') %}
                            <code class="block px-4 py-3 bg-gray-100 dark:bg-gray-700 rounded-lg text-base font-mono border border-gray-200 dark:border-gray-600 break-all text-gray-900 dark:text-white">{{ user_data.get('wallet', 'N/A') }}</code>
                        {% else %}
                            <p class="text-gray-500 dark:text-gray-400">未绑定</p>
                        {% endif %}
                    </div>
                    
                    {% if user_data.get('wallet_info') %}
                    <div class="pt-4 border-t border-gray-200 dark:border-gray-700 space-y-3">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600 dark:text-gray-400">余额</span>
                            <span class="text-base font-bold text-gray-900 dark:text-white">{{ "%.4f"|format(user_data.wallet_info.get('balance', 0)) }} SOL</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600 dark:text-gray-400">账户状态</span>
                            <span class="text-base text-gray-900 dark:text-white">{{ user_data.wallet_info.get('status', 'N/A') }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600 dark:text-gray-400">活跃状态</span>
                            <span class="text-base text-gray-900 dark:text-white">
                                {% if user_data.wallet_info.get('is_active') %}
                                    <span class="text-green-600 dark:text-green-400">✅ 是</span>
                                {% else %}
                                    <span class="text-gray-500 dark:text-gray-400">❌ 否</span>
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Edit Form -->
            <div class="rounded-[10px] bg-white shadow-md dark:bg-gray-800">
                <div class="border-b border-gray-200 px-6 py-4 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                        <i class="fas fa-edit mr-2"></i> 编辑信息
                    </h3>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-sticky-note mr-2"></i> 备注
                        </label>
                        <textarea 
                            id="noteInput" 
                            rows="3" 
                            placeholder="输入备注信息..."
                            class="block w-full px-3 py-2.5 text-base border border-gray-300 rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                        >{{ user_data.get('note', '') }}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            <i class="fas fa-wallet mr-2"></i> 钱包地址
                        </label>
                        <input 
                            type="text" 
                            id="walletInput" 
                            placeholder="钱包地址"
                            value="{{ user_data.get('wallet', '') }}"
                            class="block w-full px-3 py-2.5 text-base border border-gray-300 rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                    </div>
                    <div class="flex gap-2">
                        <button 
                            onclick="saveUser()"
                            class="flex-1 px-4 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                        >
                            <i class="fas fa-save mr-2"></i> 保存修改
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Conversation History -->
        <div class="rounded-[10px] bg-white shadow-md dark:bg-gray-800">
            <div class="border-b border-gray-200 px-6 py-4 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-comments mr-2"></i> 对话历史
                </h3>
            </div>
            <div class="p-6 max-h-[600px] overflow-y-auto" id="historyScroll">
                {% if user_data.get('history') %}
                    <div class="space-y-4" id="historyContainer">
                        {% for msg in user_data.history %}
                        <div class="flex items-start gap-3 {% if msg.role == 'user' %}flex-row-reverse{% endif %}">
                            <div class="flex-shrink-0">
                                {% if msg.role == 'user' %}
                                    <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center">
                                        <i class="fas fa-user text-white text-sm"></i>
                                    </div>
                                {% else %}
                                    <div class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center">
                                        <i class="fas fa-robot text-white text-sm"></i>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">
                                    {% if msg.role == 'user' %}用户{% else %}Bot{% endif %}
                                </div>
                                <div class="px-4 py-3 rounded-lg {{ 'bg-blue-100 dark:bg-blue-900/30 text-gray-900 dark:text-white' if msg.role == 'user' else 'bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white' }}">
                                    {{ msg.content[:500] }}{% if msg.content|length > 500 %}...{% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-12" id="historyEmpty">
                        <i class="fas fa-comment-slash text-4xl text-gray-300 dark:text-gray-600 mb-3"></i>
                        <p class="text-gray-500 dark:text-gray-400">暂无对话历史</p>
                    </div>
                {% endif %}
            </div>
            
            <!-- Send Message Input -->
            <div class="border-t border-gray-200 dark:border-gray-700 p-4 bg-gray-50 dark:bg-gray-700/50">
                <div class="space-y-2">
                    <textarea 
                        id="quickMessageInput" 
                        rows="3" 
                        placeholder="输入消息内容..."
                        class="block w-full px-3 py-2.5 text-base border border-gray-300 rounded-lg bg-white dark:bg-gray-800 dark:border-gray-600 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                    ></textarea>
                    <button 
                        onclick="sendQuickMessage()"
                        class="w-full px-4 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                    >
                        <i class="fas fa-paper-plane mr-2"></i> 发送消息
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function sendQuickMessage() {
    const messageInput = document.getElementById('quickMessageInput');
    const message = messageInput.value.trim();
    
    if (!message) {
        alert('请输入消息内容');
        return;
    }
    
    // 发送消息
    fetch('/user/{{ user_id }}/send-message', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 显示成功提示
            showSuccessMessage('消息发送成功！');
            
            // 立即在对话历史中添加新消息
            addMessageToHistory('assistant', message);
            
            // 清空输入框
            messageInput.value = '';
            
            // 不再自动刷新，防止刚追加的消息闪退
        } else {
            alert('发送失败：' + (data.error || '未知错误'));
        }
    })
    .catch(error => {
        alert('发送失败：' + error);
    });
}

function addMessageToHistory(role, content) {
    // 如果原来是空列表，替换为空容器
    const emptyEl = document.getElementById('historyEmpty');
    if (emptyEl) {
        emptyEl.outerHTML = '<div class="space-y-4" id="historyContainer"></div>';
    }

    const container = document.getElementById('historyContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'flex items-start gap-3';
    messageDiv.innerHTML = `
        <div class="flex-shrink-0">
            <div class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center">
                <i class="fas fa-robot text-white text-sm"></i>
            </div>
        </div>
        <div class="flex-1 min-w-0">
            <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">Bot</div>
            <div class="px-4 py-3 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white">
                ${content}
            </div>
        </div>
    `;
    container.appendChild(messageDiv);

    // 滚动到最新消息
    const scrollBox = document.getElementById('historyScroll');
    if (scrollBox) {
        scrollBox.scrollTop = scrollBox.scrollHeight;
    }
}

function showSuccessMessage(text) {
    // 创建成功提示
    const successDiv = document.createElement('div');
    successDiv.className = 'fixed top-20 right-6 bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 animate-slide-in';
    successDiv.style.cssText = 'animation: slideIn 0.3s ease-out;';
    successDiv.innerHTML = `
        <div class="flex items-center gap-2">
            <i class="fas fa-check-circle"></i>
            <span class="font-medium">${text}</span>
        </div>
    `;
    document.body.appendChild(successDiv);
    
    // 3秒后自动消失
    setTimeout(() => {
        successDiv.style.cssText = 'animation: slideOut 0.3s ease-out;';
        setTimeout(() => {
            successDiv.remove();
        }, 300);
    }, 2500);
}

// 已移除顶部 prompt 发送逻辑，统一使用底部输入框

function saveUser() {
    const note = document.getElementById('noteInput').value;
    const wallet = document.getElementById('walletInput').value;
    
    fetch('/user/{{ user_id }}/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            note: note,
            wallet: wallet
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('✅ 保存成功！');
            location.reload();
        } else {
            alert('❌ 保存失败：' + data.error);
        }
    })
    .catch(error => {
        alert('❌ 保存失败：' + error);
    });
}
</script>
{% endblock %}

