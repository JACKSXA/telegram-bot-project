{% extends "base_tailwind.html" %}

{% block title %}消息推送 - Bot管理后台{% endblock %}

{% block content %}
<div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
            <i class="fas fa-bullhorn mr-2"></i> 消息推送
        </h1>
        <p class="mt-2 text-base text-gray-600 dark:text-gray-400">向用户发送消息通知</p>
    </div>

    <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
        <!-- Main Form -->
        <div class="lg:col-span-2">
            <div class="rounded-[10px] bg-white shadow-md dark:bg-gray-800">
                <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                        <i class="fas fa-paper-plane mr-2"></i> 推送设置
                    </h3>
                </div>
                <div class="p-8">
                    <form method="POST" id="pushForm" onsubmit="handlePushSubmit(event)">
                        <!-- Target Users -->
                        <div class="mb-8">
                            <label class="block text-base font-semibold text-gray-700 dark:text-gray-300 mb-3">
                                <i class="fas fa-users mr-2"></i>目标用户
                            </label>
                            <select 
                                name="target_type" 
                                id="target_type" 
                                class="block w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600 text-gray-900 dark:text-white text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
                                onchange="updateTargetInfo()"
                            >
                                <option value="all">全部用户 ({{ stats.all }})</option>
                                <option value="idle">初始化用户 ({{ stats.idle }})</option>
                                <option value="wallet_waiting">等待钱包用户 ({{ stats.wallet_waiting }})</option>
                                <option value="verified">已验证用户 ({{ stats.verified }})</option>
                                <option value="waiting">等待客服用户 ({{ stats.waiting }})</option>
                                <option value="bound">已绑定用户 ({{ stats.bound }})</option>
                                <option value="selected">精确推送（指定用户ID）</option>
                            </select>
                        </div>
                        
                        <!-- User IDs Input -->
                        <div class="mb-8" id="userSelect" style="display:none;">
                            <label class="block text-base font-semibold text-gray-700 dark:text-gray-300 mb-3">
                                <i class="fas fa-id-card mr-2"></i>指定用户ID
                            </label>
                            <input 
                                type="text" 
                                name="target_users" 
                                class="block w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600 text-gray-900 dark:text-white placeholder-gray-500 text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="例如: 7897880011, 123456789"
                            >
                            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">多个用户ID用逗号分隔</p>
                        </div>
                        
                        <!-- Message Content -->
                        <div class="mb-8">
                            <label class="block text-base font-semibold text-gray-700 dark:text-gray-300 mb-3">
                                <i class="fas fa-edit mr-2"></i> 消息内容
                            </label>
                            <textarea 
                                name="message" 
                                rows="12" 
                                id="messageContent" 
                                required 
                                class="block w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600 text-gray-900 dark:text-white placeholder-gray-500 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                                placeholder="输入要推送的消息内容...

支持变量：
{username} - 用户名
{wallet} - 钱包地址
{user_id} - 用户ID

支持格式：
<b>粗体</b>
<i>斜体</i>
<code>代码</code>"
                            ></textarea>
                            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">支持HTML格式和Markdown格式</p>
                        </div>

                        <!-- Template Selector -->
                        <div class="mb-8">
                            <label class="block text-base font-semibold text-gray-700 dark:text-gray-300 mb-3">
                                <i class="fas fa-layer-group mr-2"></i> 消息模板（可选）
                            </label>
                            <div class="flex gap-3">
                                <select 
                                    id="templateSelector" 
                                    onchange="loadTemplate()"
                                    class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600 text-gray-900 dark:text-white text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    <option value="">-- 选择模板 --</option>
                                </select>
                                <button 
                                    type="button" 
                                    onclick="saveAsTemplate()"
                                    class="px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium text-base"
                                >
                                    <i class="fas fa-save mr-2"></i> 保存为模板
                                </button>
                            </div>
                            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">选择已保存的模板可快速填充内容</p>
                        </div>

                        <!-- Push Type -->
                        <div class="mb-8">
                            <label class="block text-base font-semibold text-gray-700 dark:text-gray-300 mb-3">
                                推送类型
                            </label>
                            <div class="grid grid-cols-3 gap-3">
                                <input type="radio" name="push_type" id="typeText" value="text" checked class="hidden">
                                <label for="typeText" class="flex items-center justify-center px-4 py-3.5 text-base font-semibold text-gray-700 dark:text-gray-200 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 dark:border-gray-600 has-[:checked]:bg-blue-600 has-[:checked]:text-white has-[:checked]:border-blue-600 transition-all shadow-md">
                                    <i class="fas fa-file-alt mr-2"></i> 纯文本
                                </label>
                                
                                <input type="radio" name="push_type" id="typeHTML" value="html" class="hidden">
                                <label for="typeHTML" class="flex items-center justify-center px-4 py-3.5 text-base font-semibold text-gray-700 dark:text-gray-200 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 dark:border-gray-600 has-[:checked]:bg-blue-600 has-[:checked]:text-white has-[:checked]:border-blue-600 transition-all shadow-md">
                                    <i class="fas fa-code mr-2"></i> HTML
                                </label>
                                
                                <input type="radio" name="push_type" id="typeMarkdown" value="markdown" class="hidden">
                                <label for="typeMarkdown" class="flex items-center justify-center px-4 py-3.5 text-base font-semibold text-gray-700 dark:text-gray-200 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 dark:border-gray-600 has-[:checked]:bg-blue-600 has-[:checked]:text-white has-[:checked]:border-blue-600 transition-all shadow-md">
                                    <i class="fab fa-markdown mr-2"></i> Markdown
                                </label>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="flex gap-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                            <button 
                                type="button" 
                                onclick="previewMessage()"
                                class="flex-1 px-6 py-3 border-2 border-gray-300 rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors font-medium text-base"
                            >
                                <i class="fas fa-eye mr-2"></i> 预览消息
                            </button>
                            <button 
                                type="submit" 
                                class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium text-base"
                            >
                                <i class="fas fa-paper-plane mr-2"></i> 立即推送
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Stats -->
            <div class="rounded-[10px] bg-white shadow-md dark:bg-gray-800">
                <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                        <i class="fas fa-chart-bar mr-2"></i> 用户统计
                    </h3>
                </div>
                <div class="p-6 space-y-4">
                    <div class="flex justify-between items-center pb-3 border-b border-gray-200 dark:border-gray-700">
                        <span class="text-base font-semibold text-gray-700 dark:text-gray-300">总用户数</span>
                        <span class="text-2xl font-bold text-gray-900 dark:text-white">{{ stats.all }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600 dark:text-gray-400">初始化</span>
                        <span class="text-lg font-bold text-purple-600 dark:text-purple-400">{{ stats.idle or 0 }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600 dark:text-gray-400">等待钱包</span>
                        <span class="text-lg font-bold text-orange-600 dark:text-orange-400">{{ stats.wallet_waiting or 0 }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600 dark:text-gray-400">已验证</span>
                        <span class="text-lg font-bold text-indigo-600 dark:text-indigo-400">{{ stats.verified or 0 }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600 dark:text-gray-400">等待客服</span>
                        <span class="text-lg font-bold text-yellow-600 dark:text-yellow-400">{{ stats.waiting or 0 }}</span>
                    </div>
                    <div class="flex justify-between items-center pb-3 border-b border-gray-200 dark:border-gray-700">
                        <span class="text-sm text-gray-600 dark:text-gray-400">已绑定</span>
                        <span class="text-lg font-bold text-green-600 dark:text-green-400">{{ stats.bound or 0 }}</span>
                    </div>
                    <div class="flex justify-between items-center pt-2">
                        <span class="text-sm text-gray-600 dark:text-gray-400">已完成充值</span>
                        <span class="text-lg font-bold text-blue-600 dark:text-blue-400">{{ stats.transfer_completed or 0 }}</span>
                    </div>
                </div>
            </div>

            <!-- Help -->
            <div class="rounded-[10px] bg-white shadow-md dark:bg-gray-800">
                <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                        <i class="fas fa-lightbulb mr-2"></i> 使用提示
                    </h3>
                </div>
                <div class="p-6 space-y-5">
                    <div>
                        <p class="font-semibold text-gray-900 dark:text-white mb-2">变量替换：</p>
                        <ul class="space-y-2 text-gray-600 dark:text-gray-400 text-sm">
                            <li class="flex items-center">• {username} - 用户名</li>
                            <li class="flex items-center">• {wallet} - 钱包地址</li>
                            <li class="flex items-center">• {user_id} - 用户ID</li>
                        </ul>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-900 dark:text-white mb-2">推送对象：</p>
                        <ul class="space-y-2 text-gray-600 dark:text-gray-400 text-sm">
                            <li class="flex items-center">• 全部用户 - 所有人</li>
                            <li class="flex items-center">• 等待客服 - 刚收到$100的用户</li>
                            <li class="flex items-center">• 已绑定 - 已完成绑定</li>
                            <li class="flex items-center">• 精确推送 - 指定ID</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 保存模板确认对话框 -->
<div id="saveTemplateModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md p-6 mx-4">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                <i class="fas fa-save mr-2 text-blue-600"></i> 保存为模板
            </h3>
            <button onclick="closeSaveTemplateModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                模板名称
            </label>
            <input 
                type="text" 
                id="templateNameInput" 
                placeholder="请输入模板名称"
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600 text-gray-900 dark:text-white text-base focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
        </div>
        
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                消息内容预览
            </label>
            <div class="px-4 py-3 bg-gray-50 dark:bg-gray-700 rounded-lg border-2 border-gray-200 dark:border-gray-600 max-h-32 overflow-y-auto">
                <p class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap" id="templatePreview"></p>
            </div>
        </div>
        
        <div class="flex gap-3">
            <button 
                onclick="closeSaveTemplateModal()"
                class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg bg-white dark:bg-gray-700 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors font-medium"
            >
                取消
            </button>
            <button 
                onclick="confirmSaveTemplate()"
                class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
            >
                <i class="fas fa-check mr-2"></i> 确认保存
            </button>
        </div>
    </div>
</div>

<script>
function updateTargetInfo() {
    const targetType = document.getElementById('target_type').value;
    const userSelect = document.getElementById('userSelect');
    
    if (targetType === 'selected') {
        userSelect.style.display = 'block';
    } else {
        userSelect.style.display = 'none';
    }
}

function previewMessage() {
    const message = document.getElementById('messageContent').value;
    if (!message.trim()) {
        alert('请输入要预览的消息内容');
        return;
    }
    
    const content = message
        .replace(/{username}/g, '<span class="text-blue-600 font-semibold">示例用户</span>')
        .replace(/{wallet}/g, '<span class="text-green-600 font-mono">0x1234...5678</span>')
        .replace(/{user_id}/g, '<span class="text-gray-600">123456789</span>');
    
    // 创建预览模态框
    const modal = document.createElement('div');
    modal.id = 'previewModal';
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center';
    modal.innerHTML = `
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closePreviewModal()"></div>
        <div class="relative w-full max-w-lg mx-4 bg-white dark:bg-gray-800 rounded-2xl shadow-2xl">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                    <i class="fas fa-eye mr-2"></i> 消息预览
                </h3>
                <button onclick="closePreviewModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4 flex items-center space-x-2">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center">
                            <i class="fas fa-robot text-white"></i>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Bot 将发送</div>
                    </div>
                </div>
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-gray-700 dark:to-gray-800 rounded-lg p-4 border border-blue-200 dark:border-gray-600">
                    <div class="text-gray-900 dark:text-white whitespace-pre-wrap">${content}</div>
                </div>
                <div class="mt-4 text-xs text-gray-500 dark:text-gray-400">
                    <i class="fas fa-info-circle mr-1"></i> 变量 {username}, {wallet}, {user_id} 将被实际值替换
                </div>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3">
                <button onclick="closePreviewModal()" class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                    知道了
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function closePreviewModal() {
    const modal = document.getElementById('previewModal');
    if (modal) modal.remove();
}

// ====== 模板功能 ======
function loadTemplates() {
    fetch('/api/templates')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('templateSelector');
                select.innerHTML = '<option value="">-- 选择模板 --</option>';
                data.templates.forEach(tpl => {
                    const option = document.createElement('option');
                    option.value = tpl.id;
                    option.textContent = `${tpl.name} (${tpl.type})`;
                    select.appendChild(option);
                });
            }
        });
}

function loadTemplate() {
    const select = document.getElementById('templateSelector');
    const templateId = select.value;
    if (!templateId) return;
    
    fetch('/api/templates')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const template = data.templates.find(t => t.id == templateId);
                if (template) {
                    document.getElementById('messageContent').value = template.content;
                }
            }
        });
}

function saveAsTemplate() {
    const content = document.getElementById('messageContent').value;
    if (!content.trim()) {
        showToast('请先输入消息内容', true);
        return;
    }
    
    // 显示确认对话框
    document.getElementById('templatePreview').textContent = content;
    document.getElementById('templateNameInput').value = '';
    document.getElementById('saveTemplateModal').classList.remove('hidden');
}

function closeSaveTemplateModal() {
    document.getElementById('saveTemplateModal').classList.add('hidden');
}

function confirmSaveTemplate() {
    const name = document.getElementById('templateNameInput').value.trim();
    if (!name) {
        showToast('请输入模板名称', true);
        document.getElementById('templateNameInput').focus();
        return;
    }
    
    const content = document.getElementById('messageContent').value;
    const type = document.querySelector('input[name="push_type"]:checked')?.value || 'text';
    
    fetch('/api/templates', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name, type, content})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast('模板保存成功！', false);
            loadTemplates();
            closeSaveTemplateModal();
        } else {
            showToast('保存失败：' + (data.error || '未知错误'), true);
        }
    });
}

// 页面加载时加载模板列表
document.addEventListener('DOMContentLoaded', function() {
    loadTemplates();
});

// 处理推送表单提交
function handlePushSubmit(event) {
    event.preventDefault();
    
    const form = document.getElementById('pushForm');
    const formData = new FormData(form);
    const button = form.querySelector('button[type="submit"]');
    
    // 禁用按钮
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> 发送中...';
    
    fetch('/push', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast(`成功发送 ${data.sent}/${data.total} 条消息`, false);
            // 3秒后清空表单
            setTimeout(() => {
                form.reset();
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> 立即推送';
            }, 3000);
        } else {
            showToast('推送失败：' + (data.error || '未知错误'), true);
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> 立即推送';
        }
    })
    .catch(err => {
        showToast('推送失败：' + err, true);
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> 立即推送';
    });
}

function showToast(message, isError = false) {
    const toast = document.createElement('div');
    toast.className = `${isError ? 'bg-red-500' : 'bg-green-500'} fixed top-20 right-6 text-white px-6 py-4 rounded-lg shadow-xl z-50 flex items-center gap-2 animate-slide-in`;
    toast.innerHTML = `
        <i class="fas ${isError ? 'fa-exclamation-circle' : 'fa-check-circle'}"></i>
        <span>${message}</span>
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}
</script>
{% endblock %}

