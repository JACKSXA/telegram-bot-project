# âœ… æ•°æ®åº“è¿ç§»å®ŒæˆæŠ¥å‘Š

## ğŸ‰ è¿ç§»æˆåŠŸ

**è¿ç§»æ—¶é—´**ï¼š2024å¹´12æœˆ  
**è¿ç§»æ•°æ®é‡**ï¼š1ä¸ªç”¨æˆ·  
**ç›®æ ‡æ•°æ®åº“**ï¼šuser_data.db (SQLite)  
**æºæ•°æ®**ï¼šuser_sessions.json  

---

## ğŸ“Š è¿ç§»ç»“æœ

### âœ… æˆåŠŸè¿ç§»çš„å†…å®¹
- âœ… ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆ1ä¸ªç”¨æˆ·ï¼‰
- âœ… ç”¨æˆ·çŠ¶æ€å’Œè¯­è¨€
- âœ… é’±åŒ…ä¿¡æ¯
- âœ… å¯¹è¯å†å²
- âœ… å¤‡æ³¨ä¿¡æ¯

### ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶
```
user_data.db              # SQLiteæ•°æ®åº“ï¼ˆä¸»æ•°æ®ï¼‰
backup_20251027_225920.db # è‡ªåŠ¨å¤‡ä»½æ–‡ä»¶
user_sessions.json        # åŸå§‹æ•°æ®ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰
```

---

## ğŸ”’ æ•°æ®å®‰å…¨ä¿è¯

### âœ… å·²å®ç°çš„å®‰å…¨æªæ–½
1. **æœ¬åœ°å­˜å‚¨**ï¼šæ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°ï¼Œä¸å¯¹å¤–ä¼ è¾“
2. **è‡ªåŠ¨å¤‡ä»½**ï¼šè¿ç§»æ—¶è‡ªåŠ¨åˆ›å»ºå¤‡ä»½æ–‡ä»¶
3. **ä¿ç•™åŸæ•°æ®**ï¼šuser_sessions.json ä¿ç•™ä½œä¸ºå†å²å¤‡ä»½
4. **äº‹åŠ¡ä¿æŠ¤**ï¼šè¿ç§»è¿‡ç¨‹ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ï¼Œå¤±è´¥è‡ªåŠ¨å›æ»š

### ğŸ›¡ï¸ æ•°æ®åŠ å¯†è®¡åˆ’
- [ ] é’±åŒ…åœ°å€åŠ å¯†å­˜å‚¨
- [ ] æ•æ„Ÿä¿¡æ¯è„±æ•
- [ ] æ“ä½œæ—¥å¿—åŠ å¯†

---

## ğŸ“‹ æ•°æ®åº“ç»“æ„

### 1. users è¡¨
å­˜å‚¨ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
- user_id (ä¸»é”®)
- username, first_name, last_name
- language, state
- wallet, note
- transfer_completed
- created_at, updated_at

### 2. conversations è¡¨
å­˜å‚¨å¯¹è¯å†å²
- id (ä¸»é”®)
- user_id (å¤–é”®)
- role, content
- timestamp

### 3. wallet_info è¡¨
å­˜å‚¨é’±åŒ…ä¿¡æ¯
- id (ä¸»é”®)
- user_id (å¤–é”®)
- wallet_address, balance
- status, is_active
- updated_at

### 4. push_history è¡¨
å­˜å‚¨æ¨é€è®°å½•
- id (ä¸»é”®)
- user_id (å¤–é”®)
- message, status
- sent_at

### 5. operation_logs è¡¨
å­˜å‚¨æ“ä½œæ—¥å¿—
- id (ä¸»é”®)
- user_id (å¤–é”®)
- operation_type
- details, operator
- timestamp

---

## ğŸ”„ ä¸‹ä¸€æ­¥å·¥ä½œ

### ä¼˜å…ˆçº§1ï¼šç«‹å³æ‰§è¡Œï¼ˆæœ¬å‘¨ï¼‰

#### 1. ä¿®æ”¹ Bot ä»£ç 
**æ–‡ä»¶**ï¼štg_bot_v2.py

**éœ€è¦ä¿®æ”¹çš„å‡½æ•°**ï¼š
- `load_sessions()` â†’ ä½¿ç”¨æ•°æ®åº“æŸ¥è¯¢
- `save_sessions()` â†’ ä½¿ç”¨æ•°æ®åº“ä¿å­˜
- `get_user_language()` â†’ ä»æ•°æ®åº“è·å–
- `set_user_state()` â†’ æ›´æ–°æ•°æ®åº“
- `save_user_wallet()` â†’ ä¿å­˜åˆ°æ•°æ®åº“
- `notify_admin()` â†’ ä½¿ç”¨æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯

#### 2. ä¿®æ”¹åå°ä»£ç 
**æ–‡ä»¶**ï¼šadmin_web/flask_app.py

**éœ€è¦ä¿®æ”¹çš„è·¯ç”±**ï¼š
- `/users` â†’ ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
- `/user/<user_id>` â†’ ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·è¯¦æƒ…
- `/push` â†’ ä»æ•°æ®åº“æŸ¥è¯¢ç›®æ ‡ç”¨æˆ·
- `/user/<user_id>/update` â†’ æ›´æ–°æ•°æ®åº“

### ä¼˜å…ˆçº§2ï¼šè¿‘æœŸæ‰§è¡Œï¼ˆä¸‹å‘¨ï¼‰

#### 1. æ•°æ®å¤‡ä»½è‡ªåŠ¨åŒ–
- [ ] æ¯æ—¥è‡ªåŠ¨å¤‡ä»½
- [ ] å¤‡ä»½æ–‡ä»¶ä¿ç•™ç­–ç•¥
- [ ] å¤‡ä»½æ–‡ä»¶å‹ç¼©

#### 2. æ•°æ®å¯è§†åŒ–
- [ ] è½¬åŒ–æ¼æ–—ç»Ÿè®¡
- [ ] ç”¨æˆ·å¢é•¿æ›²çº¿
- [ ] å……å€¼é‡‘é¢åˆ†æ

#### 3. ç”¨æˆ·çŠ¶æ€å¯è§†åŒ–
- [ ] æ·»åŠ è¿›åº¦æ¡
- [ ] çŠ¶æ€å¡ç‰‡
- [ ] å¿«æ·å‘½ä»¤

---

## ğŸ“ æµ‹è¯•è®¡åˆ’

### æµ‹è¯•é¡¹1ï¼šæ•°æ®è¯»å–
```python
from database_manager import get_database

db = get_database()
users = db.get_all_users()
print(f"ç”¨æˆ·æ•°: {len(users)}")
```

### æµ‹è¯•é¡¹2ï¼šæ•°æ®å†™å…¥
```python
db = get_database()
db.save_user(12345, {
    'username': 'test_user',
    'state': 'wallet_checking',
    'wallet': 'test_wallet_address'
})
```

### æµ‹è¯•é¡¹3ï¼šå¯¹è¯å†å²
```python
db = get_database()
conversations = db.get_conversations(7897880011)
print(f"å¯¹è¯è®°å½•æ•°: {len(conversations)}")
```

### æµ‹è¯•é¡¹4ï¼šå¤‡ä»½åŠŸèƒ½
```python
db = get_database()
backup_path = db.backup_database()
print(f"å¤‡ä»½è·¯å¾„: {backup_path}")
```

---

## âš ï¸ é‡è¦æé†’

### 1. æ•°æ®å…¼å®¹æ€§
- âœ… å½“å‰ä»æœ‰ `user_sessions.json` åœ¨ä½¿ç”¨
- âš ï¸ Bot å’Œåå°ä»åœ¨ä½¿ç”¨ JSON æ–‡ä»¶
- ğŸ“ éœ€è¦ä¿®æ”¹ä»£ç ä»¥ä½¿ç”¨æ•°æ®åº“

### 2. åœæ­¢æœåŠ¡
åœ¨ä¿®æ”¹ä»£ç å‰ï¼Œå»ºè®®ï¼š
```bash
# åœæ­¢Botå’Œåå°
pkill -f tg_bot_v2.py
pkill -f flask_app.py
```

### 3. æ•°æ®ä¸€è‡´æ€§
ä¿®æ”¹ä»£ç åï¼š
- å…ˆæµ‹è¯•è¯»å–
- å†æµ‹è¯•å†™å…¥
- æœ€åå®Œæ•´æµ‹è¯•æ•´ä¸ªæµç¨‹

---

## ğŸ“Š è¿ç§»éªŒè¯

### éªŒè¯æ­¥éª¤

#### 1. æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶
```bash
ls -lh user_data.db
sqlite3 user_data.db ".tables"
```

#### 2. æŸ¥è¯¢ç”¨æˆ·æ•°æ®
```bash
sqlite3 user_data.db "SELECT * FROM users;"
```

#### 3. æŸ¥è¯¢å¯¹è¯å†å²
```bash
sqlite3 user_data.db "SELECT COUNT(*) FROM conversations;"
```

---

## ğŸ¯ æˆåŠŸæŒ‡æ ‡

### çŸ­æœŸç›®æ ‡ï¼ˆæœ¬å‘¨ï¼‰
- âœ… æ•°æ®è¿ç§»å®Œæˆ
- â³ Botä½¿ç”¨æ•°æ®åº“
- â³ åå°ä½¿ç”¨æ•°æ®åº“
- â³ å®Œæ•´æµç¨‹æµ‹è¯•é€šè¿‡

### é•¿æœŸç›®æ ‡ï¼ˆæœ¬æœˆï¼‰
- â³ æ•°æ®å¤‡ä»½è‡ªåŠ¨åŒ–
- â³ è½¬åŒ–æ¼æ–—ç»Ÿè®¡
- â³ ç”¨æˆ·çŠ¶æ€å¯è§†åŒ–
- â³ æ“ä½œæ—¥å¿—è®°å½•

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### å¦‚æœé‡åˆ°é—®é¢˜
1. **æ•°æ®ä¸¢å¤±**ï¼šæ£€æŸ¥ `backup_*.db` å¤‡ä»½æ–‡ä»¶
2. **è¿ç§»å¤±è´¥**ï¼šä¿ç•™ `user_sessions.json` åŸå§‹æ•°æ®
3. **ä»£ç ä¿®æ”¹**ï¼šé€å‡½æ•°æµ‹è¯•ï¼Œç¡®ä¿æ¯ä¸ªå‡½æ•°éƒ½æ­£ç¡®

### å›æ»šæ–¹æ¡ˆ
å¦‚æœéœ€è¦å›é€€åˆ°JSONï¼š
```bash
# åœæ­¢æœåŠ¡
pkill -f tg_bot_v2.py
pkill -f flask_app.py

# æ¢å¤åŸå§‹ä»£ç ï¼ˆä¸ä½¿ç”¨æ•°æ®åº“ï¼‰
git checkout tg_bot_v2.py
git checkout admin_web/flask_app.py

# é‡å¯æœåŠ¡
python tg_bot_v2.py &
python admin_web/flask_app.py &
```

---

## âœ¨ å®ŒæˆçŠ¶æ€

- âœ… **æ•°æ®åº“è¿ç§»å®Œæˆ**
- âœ… **è‡ªåŠ¨å¤‡ä»½å·²åˆ›å»º**
- âœ… **æ•°æ®ç»“æ„å·²è®¾è®¡**
- â³ **ä»£ç ä¿®æ”¹å¾…è¿›è¡Œ**
- â³ **æµ‹è¯•å¾…éªŒè¯**

**ä¸‹ä¸€æ­¥ï¼šä¿®æ”¹Botå’Œåå°ä»£ç ä»¥ä½¿ç”¨æ•°æ®åº“**

